{% extends "base.html" %}

{% block title %}Edit Profile - Public Health Record System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 offset-md-2">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h4>Edit Profile</h4>
            </div>
            <div class="card-body">
                <form method="POST">
                    <!-- Common Fields -->
                    <div class="mb-3">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-control" value="{{ current_user.name }}" disabled>
                        <div class="form-text">Name cannot be changed.</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" value="{{ current_user.email }}" disabled>
                        <div class="form-text">Email cannot be changed.</div>
                    </div>

                    {% if current_user.role == 'patient' %}
                    <h5 class="mt-4 mb-3">Personal Details</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="age" class="form-label">Age</label>
                            <input type="number" class="form-control" id="age" name="age"
                                value="{{ current_user.age or '' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="gender" class="form-label">Gender</label>
                            <select class="form-select" id="gender" name="gender">
                                <option value="" {% if not current_user.gender %}selected{% endif %}>Select</option>
                                <option value="Male" {% if current_user.gender=='Male' %}selected{% endif %}>Male
                                </option>
                                <option value="Female" {% if current_user.gender=='Female' %}selected{% endif %}>Female
                                </option>
                                <option value="Other" {% if current_user.gender=='Other' %}selected{% endif %}>Other
                                </option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="blood_group" class="form-label">Blood Group</label>
                            <select class="form-select" id="blood_group" name="blood_group">
                                <option value="" {% if not current_user.blood_group %}selected{% endif %}>Select
                                </option>
                                <option value="A+" {% if current_user.blood_group=='A+' %}selected{% endif %}>A+
                                </option>
                                <option value="A-" {% if current_user.blood_group=='A-' %}selected{% endif %}>A-
                                </option>
                                <option value="B+" {% if current_user.blood_group=='B+' %}selected{% endif %}>B+
                                </option>
                                <option value="B-" {% if current_user.blood_group=='B-' %}selected{% endif %}>B-
                                </option>
                                <option value="O+" {% if current_user.blood_group=='O+' %}selected{% endif %}>O+
                                </option>
                                <option value="O-" {% if current_user.blood_group=='O-' %}selected{% endif %}>O-
                                </option>
                                <option value="AB+" {% if current_user.blood_group=='AB+' %}selected{% endif %}>AB+
                                </option>
                                <option value="AB-" {% if current_user.blood_group=='AB-' %}selected{% endif %}>AB-
                                </option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="contact_number" class="form-label">Contact Number</label>
                            <input type="text" class="form-control" id="contact_number" name="contact_number"
                                value="{{ current_user.contact_number or '' }}">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="address" class="form-label">Address</label>
                        <textarea class="form-control" id="address" name="address"
                            rows="3">{{ current_user.address or '' }}</textarea>
                    </div>

                    {% elif current_user.role == 'doctor' %}
                    <h5 class="mt-4 mb-3">Professional Details</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="specialization" class="form-label">Specialization</label>
                            <input type="text" class="form-control" id="specialization" name="specialization"
                                value="{{ current_user.specialization or '' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="experience_years" class="form-label">Experience (Years)</label>
                            <input type="number" class="form-control" id="experience_years" name="experience_years"
                                value="{{ current_user.experience_years or '' }}">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="contact_number" class="form-label">Contact Number</label>
                            <input type="text" class="form-control" id="contact_number" name="contact_number"
                                value="{{ current_user.contact_number or '' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="available_time" class="form-label">Available Time</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="available_time" name="available_time"
                                    value="{{ current_user.available_time or '' }}"
                                    placeholder="e.g. Mon-Fri 09:00-17:00">
                                <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal"
                                    data-bs-target="#availabilityModal">Generate</button>
                            </div>
                        </div>
                    </div>
                    {% endif %}



                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('profile') }}" class="btn btn-secondary me-md-2">Cancel</a>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block modals %}
<!-- Availability Generator Modal -->
<div class="modal fade" id="availabilityModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Generate Availability</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h6>Select Days</h6>
                <div class="btn-group" role="group" aria-label="Day selection">
                    <input type="checkbox" class="btn-check" id="day_Mon" value="Mon" autocomplete="off">
                    <label class="btn btn-outline-primary" for="day_Mon">Mon</label>
                    <input type="checkbox" class="btn-check" id="day_Tue" value="Tue" autocomplete="off">
                    <label class="btn btn-outline-primary" for="day_Tue">Tue</label>
                    <input type="checkbox" class="btn-check" id="day_Wed" value="Wed" autocomplete="off">
                    <label class="btn btn-outline-primary" for="day_Wed">Wed</label>
                    <input type="checkbox" class="btn-check" id="day_Thu" value="Thu" autocomplete="off">
                    <label class="btn btn-outline-primary" for="day_Thu">Thu</label>
                    <input type="checkbox" class="btn-check" id="day_Fri" value="Fri" autocomplete="off">
                    <label class="btn btn-outline-primary" for="day_Fri">Fri</label>
                    <input type="checkbox" class="btn-check" id="day_Sat" value="Sat" autocomplete="off">
                    <label class="btn btn-outline-primary" for="day_Sat">Sat</label>
                    <input type="checkbox" class="btn-check" id="day_Sun" value="Sun" autocomplete="off">
                    <label class="btn btn-outline-primary" for="day_Sun">Sun</label>
                </div>

                <h6 class="mt-3">Select Time Range</h6>
                <div class="row">
                    <div class="col">
                        <input type="time" class="form-control" id="startTime" value="09:00">
                    </div>
                    <div class="col-auto align-self-center">to</div>
                    <div class="col">
                        <input type="time" class="form-control" id="endTime" value="17:00">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="generateAvailability()">Apply</button>
            </div>
        </div>
    </div>
</div>

<script>
    function generateAvailability() {
        const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        let selectedDays = [];
        days.forEach(day => {
            if (document.getElementById('day_' + day).checked) {
                selectedDays.push(day);
            }
        });

        if (selectedDays.length === 0) {
            alert('Please select at least one day.');
            return;
        }

        // Smart grouping for days (e.g., Mon-Fri)
        let dayString = selectedDays.join(', ');
        if (selectedDays.length === 5 && selectedDays[0] === 'Mon' && selectedDays[4] === 'Fri') {
            dayString = 'Mon-Fri';
        }

        const startTime = document.getElementById('startTime').value;
        const endTime = document.getElementById('endTime').value;

        const availabilityString = `${dayString} ${startTime}-${endTime}`;
        document.getElementById('available_time').value = availabilityString;

        // Close modal
        var myModalEl = document.getElementById('availabilityModal');
        var modal = bootstrap.Modal.getInstance(myModalEl);
        modal.hide();
    }
</script>
{% endblock %}