{% extends "base.html" %}

{% block title %}Appointments - Doctor{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2>Manage Appointments</h2>
        <hr>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                Patient Appointments
            </div>
            <div class="card-body">
                <!-- Filter Form -->
                <form method="GET" action="{{ url_for('appointments') }}" class="row g-3 mb-4">
                    <div class="col-auto">
                        <select name="status" class="form-select">
                            <option value="">All Statuses</option>
                            <option value="Pending" {% if request.args.get('status')=='Pending' %}selected{% endif %}>
                                Pending</option>
                            <option value="Approved" {% if request.args.get('status')=='Approved' %}selected{% endif %}>
                                Approved</option>
                            <option value="Rejected" {% if request.args.get('status')=='Rejected' %}selected{% endif %}>
                                Rejected</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <input type="text" name="q" class="form-control" placeholder="Search Patient Name"
                            value="{{ request.args.get('q') or '' }}">
                    </div>
                    <div class="col-auto">
                        <input type="date" name="date" class="form-control"
                            value="{{ request.args.get('date') or '' }}">
                    </div>
                    <div class="col-auto">
                        <button type="submit" class="btn btn-secondary">Filter</button>
                        <a href="{{ url_for('appointments') }}" class="btn btn-outline-secondary">Reset</a>
                    </div>
                </form>

                {% if appointments %}
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Patient Name</th>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for appointment in appointments %}
                        <tr>
                            <td>{{ appointment.patient_name }}</td>
                            <td>{{ appointment.date }}</td>
                            <td>{{ appointment.time }}</td>
                            <td>
                                {% if appointment.status == 'Approved' %}
                                <span class="badge bg-success">Approved</span>
                                {% elif appointment.status == 'Rejected' %}
                                <span class="badge bg-danger">Rejected</span>
                                {% else %}
                                <span class="badge bg-warning text-dark">Pending</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if appointment.status == 'Pending' %}
                                <a href="{{ url_for('view_patient_profile', patient_id=appointment.patient_id) }}"
                                    class="btn btn-sm btn-info text-white">View Profile</a>

                                <form method="POST"
                                    action="{{ url_for('update_appointment', appointment_id=appointment.id) }}"
                                    style="display:inline;">
                                    <input type="hidden" name="status" value="Approved">
                                    <button type="submit" class="btn btn-sm btn-success">Approve</button>
                                </form>

                                <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal"
                                    data-bs-target="#rejectModal{{ appointment.id }}">
                                    Reject
                                </button>
            </div>

            {% elif appointment.status == 'Approved' %}
            <div class="d-flex gap-2">
                <a href="{{ url_for('view_patient_profile', patient_id=appointment.patient_id) }}"
                    class="btn btn-sm btn-info text-white">View Profile</a>

                <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal"
                    data-bs-target="#completeModal{{ appointment.id }}">
                    Complete Consultation
                </button>
            </div>

            {% else %}
            <a href="{{ url_for('view_patient_profile', patient_id=appointment.patient.id) }}"
                class="btn btn-sm btn-info text-white">View Profile</a>
            <button class="btn btn-sm btn-secondary" disabled>Processed</button>
            {% endif %}
            </td>
            </tr>
            {% endfor %}
            </tbody>
            </table>
            {% else %}
            <p>No appointments assigned to you.</p>
            {% endif %}
        </div>
    </div>
</div>
</div>

{% block modals %}
<!-- Modals moved outside the card/table to avoid z-index/transform issues -->
{% for appointment in appointments %}

<!-- Reject Modal (Only for Pending) -->
{% if appointment.status == 'Pending' %}
<div class="modal fade" id="rejectModal{{ appointment.id }}" tabindex="-1"
    aria-labelledby="rejectModalLabel{{ appointment.id }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="rejectModalLabel{{ appointment.id }}">Reject
                    Appointment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('update_appointment', appointment_id=appointment.id) }}">
                <div class="modal-body">
                    <p>Are you sure you want to reject this appointment?</p>
                    <div class="mb-3">
                        <label for="reason" class="form-label">Reason for
                            Rejection</label>
                        <textarea class="form-control" id="reason" name="reason" rows="3" required></textarea>
                    </div>
                    <input type="hidden" name="status" value="Rejected">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Reject
                        Appointment</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- Complete Consultation Modal (Only for Approved) -->
{% if appointment.status == 'Approved' %}
<div class="modal fade" id="completeModal{{ appointment.id }}" tabindex="-1"
    aria-labelledby="completeModalLabel{{ appointment.id }}" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="completeModalLabel{{ appointment.id }}">Complete Consultation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" enctype="multipart/form-data"
                action="{{ url_for('update_appointment', appointment_id=appointment.id) }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="symptoms" class="form-label">Symptoms</label>
                        <textarea class="form-control" id="symptoms" name="symptoms" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="diagnosis" class="form-label">Diagnosis</label>
                        <textarea class="form-control" id="diagnosis" name="diagnosis" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="advice" class="form-label">Advice / Prescription</label>
                        <textarea class="form-control" id="advice" name="advice" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="prescription" class="form-label">Upload Prescription/Report (PDF/Image)</label>
                        <input class="form-control" type="file" id="prescription" name="prescription">
                    </div>

                    <input type="hidden" name="status" value="Completed">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Complete & Save</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

{% endfor %}
{% endblock %}

{% endblock %}